<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Manage Offers</title>
<style>
body{font-family:system-ui;background:#f4f6f9;margin:0;padding:20px;}
h2{margin-bottom:15px;}
form{margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;}
form input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;}
form label{display:flex;align-items:center;gap:6px;}
form button{padding:8px 16px;background:#2874f0;color:white;border:none;border-radius:6px;cursor:pointer;}
table{width:100%;border-collapse:collapse;background:white;border-radius:6px;overflow:hidden;}
th,td{padding:10px;text-align:left;border-bottom:1px solid #eee;}
th{background:#f4f6f9;}
button.action{padding:4px 8px;margin-right:4px;border:none;border-radius:4px;cursor:pointer;}
button.activate{background:#388e3c;color:white;}
button.deactivate{background:#f57c00;color:white;}
button.delete{background:#e53935;color:white;}
</style>
</head>
<body>

<h2>Manage Offers</h2>

<form id="offerForm">
  <input type="text" id="offerTitle" placeholder="Offer text" required>
  <label>
    Active?
    <input type="checkbox" id="offerActive">
  </label>
  <button type="submit">Add Offer</button>
</form>

<table id="offersTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Active</th>
      <th>Created At</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
  </tbody>
</table>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://ooiumaohawwtqtiodqcv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vaXVtYW9oYXd3dHF0aW9kcWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDQ1MjMsImV4cCI6MjA4NjcyMDUyM30.S_1J8CFMa1KJUYfk1VYeUcFRqUo23NEGzNlxr5fQsvA"
)

/* LOAD OFFERS */
async function loadOffers(){
  const { data, error } = await supabase.from('offers').select('*').order('id',{ascending:false})
  const tbody = document.querySelector('#offersTable tbody')
  if(error || !data || data.length===0){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No offers found</td></tr>`
    return
  }

  tbody.innerHTML = ''
  data.forEach(offer => {
    tbody.innerHTML += `
      <tr>
        <td>${offer.id}</td>
        <td>${offer.title}</td>
        <td>${offer.active ? '✅' : '❌'}</td>
        <td>${new Date(offer.created_at).toLocaleString()}</td>
        <td>
          ${offer.active 
            ? `<button class="action deactivate" onclick="toggleActive(${offer.id}, false)">Deactivate</button>` 
            : `<button class="action activate" onclick="toggleActive(${offer.id}, true)">Activate</button>`}
          <button class="action delete" onclick="deleteOffer(${offer.id})">Delete</button>
        </td>
      </tr>
    `
  })
}

/* ADD OFFER */
document.getElementById('offerForm').addEventListener('submit', async (e)=>{
  e.preventDefault()
  const title = document.getElementById('offerTitle').value
  const active = document.getElementById('offerActive').checked

  if(active){
    // Deactivate all others
    await supabase.from('offers').update({active:false})
  }

  const { data, error } = await supabase.from('offers').insert([{title, active}])
  if(error){
    alert('Error: '+error.message)
  }else{
    alert('Offer added!')
    document.getElementById('offerForm').reset()
    loadOffers()
  }
})

/* TOGGLE ACTIVE */
window.toggleActive = async (id, makeActive)=>{
  if(makeActive){
    await supabase.from('offers').update({active:false}) // deactivate all
  }
  await supabase.from('offers').update({active:makeActive}).eq('id', id)
  loadOffers()
}

/* DELETE OFFER */
window.deleteOffer = async (id)=>{
  if(confirm("Are you sure to delete this offer?")){
    await supabase.from('offers').delete().eq('id', id)
    loadOffers()
  }
}

// Initial load
loadOffers()
</script>

</body>
</html>
